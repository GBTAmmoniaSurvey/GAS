##################################
Improved integrated intensity maps
##################################

Given the constrains on the First Look functions to keep things simple, the integrated intensity map of the NH\ :sub:`3` lines only include the emission from the main component.
As a solution, we have implemented a function that will use the results from the previous line fitting to determine the channel range with signal for the integrated intensity calculation.
The function `update_NH3_moment0` is within `PropertyMaps` and it will also create a new FITS file for each NH\ :sub:`3` integrated intensity map.

Here is an example of its usage:

  .. code-block:: python
    import GAS
    import GAS.PropertyMaps
    GAS.PropertyMaps.update_NH3_moment0(region_name='OrionA', file_extension='_DR1', threshold=0.0125, save_masked=True)

Here the key parameter is the `threshold` used to identify the channels to select. Given the best fit model for the entire map we produce the cube with the emission predicted by the model. Then, we select all the voxels (3D "pixels") with brightness higher than `threshold`.

In addition, the function will calculate the uncertainty at each pixel, since the channel range will depend on the line profile.

********************
Is it really better?
********************

Is this method really better than just selecting a fixed range of channels? Specially for the lower brightness lines. 

We have taken the OrionA map to better show the difference. Here, we show the NH\ :sub:`3` integrated intensity map generated by the first look pipeline with two different color ranges: *Left* panel shows the map with a wide color range to show the full dynamic range of the region, *Right* panel shows the map with a narrower color range to enhance the fainter emission.

  .. figure:: figures/OrionA_NH3_11_TdV_FL.png
   :width: 500px
   :alt: TdV NH3(1,1) First Look
   
In comparison, similar color stretches are are shown for the improved inetgrated intensity maps, showing a much better noise level at the low brightness emission region:

  .. figure:: figures/OrionA_NH3_11_TdV_QA.png
   :width: 500px
   :alt: TdV NH3(1,1) Improved maps

Caveats
=======

This method for improving the integrated intensity 

Also, we see that in some regions this works very well,

  .. figure:: figures/OrionA_compare_spectra_pos0.png
   :width: 350px
   :alt: NH3(1,1) where it works


while in others the masking does not catch all the emission from faint components at different velocities.

  .. figure:: figures/OrionA_compare_spectra_pos1.png
   :width: 350px
   :alt: NH3(1,1) where it does not work very well
